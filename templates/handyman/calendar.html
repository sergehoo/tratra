{% extends "handyman/base_handyman.html" %}
{% load static %}



{% block content %}
<style>
    .fc-event {
        cursor: pointer;
        border-radius: 6px;
        padding: 2px 4px;
    }
    .fc-event-availability {
        background-color: rgba(16, 185, 129, 0.2) !important;
        border: none;
    }
    .fc-daygrid-event {
        border-radius: 4px;
    }
    .booking-details-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .booking-details-card:hover {
        transform: translateY(-3px);
    }
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .fc-toolbar-title {
        font-size: 1.25rem;
        font-weight: 600;
    }
    #calendar {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
</style>
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Mon Calendrier</h1>
            <p class="text-gray-600">Gérez vos réservations et disponibilités</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="{% url 'handyman_profile_update' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow">
                <i class="fas fa-edit mr-2"></i> Modifier mes disponibilités
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Calendrier -->
        <div class="lg:col-span-2">
            <div id="calendar" class="p-4 rounded-2xl shadow-sm"></div>
        </div>

        <!-- Détails et actions -->
        <div class="space-y-6">
            <!-- Légende -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Légende du calendrier</h2>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#10B981] rounded mr-3"></div>
                        <span class="text-sm">Disponible</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#FBBF24] rounded mr-3"></div>
                        <span class="text-sm">En attente</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#10B981] rounded mr-3"></div>
                        <span class="text-sm">Confirmé</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#3B82F6] rounded mr-3"></div>
                        <span class="text-sm">En cours</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#6B7280] rounded mr-3"></div>
                        <span class="text-sm">Terminé</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#EF4444] rounded mr-3"></div>
                        <span class="text-sm">Annulé</span>
                    </div>
                </div>
            </div>

            <!-- Détails de la réservation sélectionnée -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Détails de la réservation</h2>
                <div id="booking-details" class="text-center py-8 text-gray-500">
                    <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                    <p>Sélectionnez une réservation pour voir les détails</p>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Statistiques du mois</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-green-700" id="confirmed-count">0</div>
                        <div class="text-sm text-green-600">Confirmées</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-blue-700" id="completed-count">0</div>
                        <div class="text-sm text-blue-600">Terminées</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-yellow-700" id="pending-count">0</div>
                        <div class="text-sm text-yellow-600">En attente</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <div class="text-xl font-bold text-gray-700" id="total-count">0</div>
                        <div class="text-sm text-gray-600">Total</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/fr.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser le calendrier
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'fr',
            firstDay: 1, // Lundi comme premier jour
            events: JSON.parse('{{ bookings|escapejs }}').concat(JSON.parse('{{ availability|escapejs }}')),
            eventClick: function(info) {
                if (info.event.extendedProps.type !== 'availability') {
                    showBookingDetails(info.event);
                }
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps.type === 'availability') {
                    info.el.classList.add('fc-event-availability');
                }
            },
            datesSet: function(info) {
                updateBookingStats(info.start, info.end);
            }
        });
        
        calendar.render();
        
        // Afficher les détails d'une réservation
        function showBookingDetails(event) {
            const extendedProps = event.extendedProps;
            const startDate = new Date(event.start);
            const endDate = event.end ? new Date(event.end) : null;
            
            const detailsHtml = `
                <div class="booking-details-card border-l-4" style="border-color: ${event.backgroundColor}">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-800">${event.title}</h3>
                            <span class="status-badge" style="background-color: ${event.backgroundColor}; color: white">
                                ${extendedProps.status}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center text-gray-600 mb-1">
                                <i class="far fa-calendar mr-2"></i>
                                ${startDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="far fa-clock mr-2"></i>
                                ${startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} 
                                ${endDate ? ' - ' + endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : ''}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center text-gray-600 mb-2">
                                <i class="fas fa-user mr-2"></i>
                                <span class="font-medium">Client:</span> ${extendedProps.client}
                            </div>
                            <div class="flex items-start text-gray-600">
                                <i class="fas fa-map-marker-alt mt-1 mr-2"></i>
                                <span>${extendedProps.address}</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-700">${extendedProps.description}</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <a href="/booking/${event.id}/" class="flex-1 text-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                                <i class="fas fa-eye mr-1"></i> Détails
                            </a>
                            <button class="px-3 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition text-sm">
                                <i class="fas fa-edit mr-1"></i> Modifier
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('booking_detail').innerHTML = detailsHtml;
        }
        
        // Mettre à jour les statistiques
        function updateBookingStats(start, end) {
            // Compter les réservations dans la période visible
            const events = calendar.getEvents();
            let confirmed = 0, completed = 0, pending = 0;
            
            events.forEach(event => {
                if (event.extendedProps.type !== 'availability') {
                    const eventStart = event.start;
                    if (eventStart >= start && eventStart <= end) {
                        if (event.extendedProps.status === "Confirmé") confirmed++;
                        if (event.extendedProps.status === "Terminé") completed++;
                        if (event.extendedProps.status === "En attente") pending++;
                    }
                }
            });
            
            document.getElementById('confirmed-count').textContent = confirmed;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('total-count').textContent = confirmed + completed + pending;
        }
        
        // Initialiser les statistiques
        const initialStart = new Date('{{ today|escapejs }}');
        const initialEnd = new Date(initialStart);
        initialEnd.setMonth(initialEnd.getMonth() + 1);
        updateBookingStats(initialStart, initialEnd);
    });
</script>
{% endblock %}