<!-- Template optimisé -->
{% extends "handyman/base_handyman.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Mettre à jour mon profil</h1>
    
    <!-- Barre de progression responsive -->
    <div class="flex items-center">
      <span class="text-sm text-gray-600 mr-3 whitespace-nowrap">Complétion du profil:</span>
      <div class="w-24 md:w-32 bg-gray-200 rounded-full h-2.5">
        <div class="bg-green-600 h-2.5 rounded-full" style="width: {{ object.profile_completion }}%"></div>
      </div>
      <span class="text-sm font-medium text-gray-700 ml-2">{{ object.profile_completion }}%</span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
    <!-- Section gauche : Profil rapide -->
    <div class="lg:col-span-1 space-y-6">
      <div class="bg-white rounded-xl shadow p-6">
        <div class="text-center mb-6">
          <div class="relative w-24 h-24 md:w-32 md:h-32 rounded-full overflow-hidden border-4 border-green-100 mx-auto">
            {% if object.photo %}
              <img src="{{ object.photo.url }}" alt="Photo de profil" class="w-full h-full object-cover">
            {% else %}
              <div class="bg-gray-200 flex items-center justify-center w-full h-full">
                <i class="fas fa-user text-gray-400 text-3xl md:text-4xl"></i>
              </div>
            {% endif %}
          </div>
          <h2 class="text-lg md:text-xl font-bold mt-4">{{ user.get_full_name }}</h2>
          <p class="text-gray-500 text-sm md:text-base">{{ object.bio|default:"Artisan multiservice"|truncatechars:30 }}</p>
        </div>

        <div class="space-y-4">
          <!-- Note -->
          <div class="flex items-center">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600 mr-3">
              <i class="fas fa-star text-sm md:text-base"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Note moyenne</p>
              <p class="font-bold text-sm md:text-base">{{ object.rating|floatformat:1 }}/5 ({{ object.completed_jobs }} missions)</p>
            </div>
          </div>

          <!-- Expérience -->
          <div class="flex items-center">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600 mr-3">
              <i class="fas fa-briefcase text-sm md:text-base"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Expérience</p>
              <p class="font-bold text-sm md:text-base">{{ object.experience_years }} ans</p>
            </div>
          </div>

          <!-- Statut vérification -->
          <div class="flex items-center">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600 mr-3">
              <i class="fas fa-check-circle text-sm md:text-base"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Vérification</p>
              <p class="font-bold text-sm md:text-base">
                {% if object.is_approved %}
                  <span class="text-green-600">Vérifié</span>
                {% else %}
                  <span class="text-yellow-600">En cours</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Documents -->
      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-base md:text-lg mb-4 flex items-center">
          <i class="fas fa-file-alt text-green-600 mr-2"></i> Documents
        </h3>
        <div class="border border-dashed border-gray-300 rounded-lg p-4 md:p-6 text-center">
          <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl md:text-4xl mb-3"></i>
          <p class="text-gray-600 text-sm md:text-base mb-2">Glissez-déposez vos fichiers ici</p>
          <p class="text-xs text-gray-500 mb-4">ou</p>
          <button type="button" class="px-3 py-1.5 md:px-4 md:py-2 bg-green-50 text-green-700 rounded-lg font-medium hover:bg-green-100 transition text-sm">
            <i class="fas fa-plus mr-2"></i> Ajouter un document
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-4">
          <i class="fas fa-info-circle text-green-600 mr-1"></i>  
          Documents : CNI, permis, assurance pro.
        </p>
      </div>
    </div>

    <!-- Section droite : Formulaire -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-4">
          <h2 class="text-lg md:text-xl font-bold text-white">
            <i class="fas fa-user-edit mr-2"></i> Mise à jour du profil
          </h2>
        </div>
        <form method="post" enctype="multipart/form-data" class="p-4 md:p-6">
          {% csrf_token %}
          
          {% if form.non_field_errors %}
            <div class="mb-4 p-3 bg-red-50 text-red-700 rounded-lg">
              {% for error in form.non_field_errors %}
                <p class="text-sm">{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
            <!-- Col gauche -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">{{ form.bio.label }}</label>
                {{ form.bio }}
                {% for error in form.bio.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Compétences</label>
                {{ form.skills }}
                {% for error in form.skills.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>
            <div>
                <label class="block text-sm font-medium mb-1">Année d'expérience</label>
                {{ form.experience_years }}
                {% for error in form.experience_years.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Tarification</label>
                <div class="space-y-3">
                  <div>
                    <label class="text-xs block mb-1">Horaire (FCFA/h)</label>
                    {{ form.hourly_rate }}
                    {% for error in form.hourly_rate.errors %}
                      <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                    {% endfor %}
                  </div>
                  <div>
                    <label class="text-xs block mb-1">Journalier (FCFA)</label>
                    {{ form.daily_rate }}
                    {% for error in form.daily_rate.errors %}
                      <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                    {% endfor %}
                  </div>
                  <div>
                    <label class="text-xs block mb-1">Mensuel (FCFA)</label>
                    {{ form.monthly_rate }}
                    {% for error in form.monthly_rate.errors %}
                      <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Col droite -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Infos légales</label>
                <div class="space-y-3">
                  <div>
                    <label class="text-xs block mb-1">N° Licence</label>
                    {{ form.license_number }}
                  </div>
                  <div>
                    <label class="text-xs block mb-1">N° CNI</label>
                    {{ form.cni_number }}
                    {% for error in form.cni_number.errors %}
                      <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                    {% endfor %}
                  </div>
                  <div>
                    <label class="text-xs block mb-1">Assurance</label>
                    {{ form.insurance_info }}
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Frais déplacement (FCFA)</label>
                {{ form.travel_fee }}
                {% for error in form.travel_fee.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">
                  <i class="fas fa-calendar-check text-green-600 mr-2"></i> Disponibilités
                </label>
                {{ form.availability_choices }}
                {% for error in form.availability_choices.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label class="block text-sm font-medium mb-1">Photo de profil</label>
                <div class="flex items-center">
                  {{ form.photo }}
                  {% if object.photo %}
                    <a href="{{ object.photo.url }}" target="_blank" class="ml-3 text-sm text-green-600 hover:underline whitespace-nowrap">
                      <i class="fas fa-eye mr-1"></i> Voir
                    </a>
                  {% endif %}
                </div>
                {% for error in form.photo.errors %}
                  <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="flex flex-col-reverse sm:flex-row justify-between items-center gap-4 border-t pt-6">
            <a href="{% url 'handydash' %}" class="px-4 py-2 md:px-6 md:py-2.5 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition w-full sm:w-auto text-center">
              <i class="fas fa-arrow-left mr-2"></i> Retour
            </a>
            <button type="submit" class="px-4 py-2 md:px-6 md:py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow transition w-full sm:w-auto text-center">
              <i class="fas fa-save mr-2"></i> Enregistrer
            </button>
          </div>
        </form>
      </div>

      <!-- Conseils -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 md:p-5 mt-6 md:mt-8">
        <div class="flex">
          <div class="mt-0.5">
            <i class="fas fa-lightbulb text-yellow-500 text-lg md:text-xl"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Conseils pour optimiser votre profil</h3>
            <ul class="mt-1 text-sm text-yellow-700 space-y-1">
              <li class="flex items-start">
                <span class="mr-2">✔️</span>
                <span>Un profil complet attire plus de clients</span>
              </li>
              <li class="flex items-start">
                <span class="mr-2">✔️</span>
                <span>Ajoutez des photos de vos réalisations</span>
              </li>
              <li class="flex items-start">
                <span class="mr-2">✔️</span>
                <span>Maintenez vos disponibilités à jour</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Select2 CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialise TOUTES les Select2 sur la page
    $('.select2-multiple').each(function() {
      let $select = $(this);

      $select.select2({
        placeholder: $select.data('placeholder') || 'Sélectionnez...',
        allowClear: true,
        width: '100%',
        templateResult: formatOption,
        templateSelection: formatOption
      });
    });

    function formatOption(state) {
      if (!state.id) {
        return state.text;
      }

      // Vérifie le nom exact du select pour cibler la logique
      if (state.element && state.element.closest('select').id === 'id_availability_choices') {
        const parts = state.text.split(' - ');
        if (parts.length === 2) {
          return $('<span><span class="font-semibold">' + parts[0] +
                    '</span> - ' + parts[1] + '</span>');
        }
      }

      return state.text;
    }
  });
</script>
{% endblock %}